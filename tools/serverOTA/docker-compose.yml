# ============================================================
# Docker Compose - ESP32 OTA Server
# Tương thích Portainer Git Repository Deploy
# ============================================================
#
# Deploy qua Portainer Git:
#   1. Stacks → Add Stack → chọn "Repository"
#   2. Repository URL: https://github.com/Kurtt806/KHOA_COMPONENTS.git
#   3. Compose path: tools/docker/docker-compose.yml
#   4. Deploy the stack
#
# Sau khi deploy, upload firmware:
#   docker cp my_app.bin esp32-ota-server:/firmware/
#   docker restart esp32-ota-server
#
# Hoặc mount thư mục firmware từ host (uncomment volume bên dưới)
# ============================================================

services:
  ota-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: esp32-ota-server
    restart: unless-stopped

    # ── Port mapping ──
    ports:
      - "3001:3001"

    # ── Biến môi trường (chỉnh trong Portainer UI) ──
    environment:
      - OTA_PORT=3001
      - OTA_VERSION=1.0.0          # Version firmware hiện tại
      - OTA_TOKEN=                  # VIBO-KEY (để trống = không yêu cầu)
      - OTA_BASE_URL=http://ota.vibohub.com  # URL public cho ESP32 (domain = không port)
      - OTA_FIRMWARE_DIR=/firmware
      - OTA_DATA_DIR=/data
      - TZ=Asia/Ho_Chi_Minh         # Timezone Việt Nam

    # ── Volume mount ──
    volumes:
      # Dữ liệu thiết bị persist qua restart/redeploy
      - ota_data:/data

      # Firmware: chọn 1 trong 2 cách bên dưới
      # Cách 1: Named volume (upload firmware bằng docker cp)
      - ota_firmware:/firmware

      # Cách 2: Mount thư mục từ host server (uncomment dòng dưới, comment dòng trên)
      # - /opt/ota-firmware:/firmware:ro

    # ── Portainer labels ──
    labels:
      - "com.portainer.stack=ota-server"
      - "description=ESP32 OTA Firmware Server with Web Dashboard"

    # ── Logging giới hạn để không đầy ổ đĩa ──
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# Volumes được quản lý bởi Docker (persist qua redeploy)
volumes:
  ota_data:
    name: esp32_ota_data
  ota_firmware:
    name: esp32_ota_firmware
